'use strict';

angular.module('valueprop').controller('main', function ($scope, FIRE_OBJ, FIRE_ARRAY, GET_FIRE, FIRE_COMMENT, $uibModal, $log, $stateParams, $state, $rootScope) {

  var vm = this;

  vm.animationsEnabled = true;

  vm.addConsideration = function () {
    var modalInstance = $uibModal.open({
      animation: vm.animationsEnabled,
      templateUrl: 'assets/components/addConsid.html',
      controller: 'considModalCtrl'
    });

    modalInstance.result.then(function (formData) {
      FIRE_ARRAY.$add(formData).then(function (result) {
        console.log(result.ref());
      });
    });
  };

  vm.addComment = function () {
    var modalInstance = $uibModal.open({
      animation: vm.animationsEnabled,
      templateUrl: 'assets/components/addComment.html',
      controller: 'commModalCtrl'
    });

    modalInstance.result.then(function (formData) {
      FIRE_COMMENT.$add(formData).then(function (result) {
        console.log(result.ref());
      });
    });
  };

  $rootScope.$on('$stateChangeStart', function (toState, fromState) {
    console.log(toState);
    console.log(fromState);

    if (fromState.name === 'start.dash.consid') {
      $rootScope.params = true;

      GET_FIRE.on('value', function (snap) {
        vm.comments = snap.val();
      }, function (errorObject) {
        console.log("The read failed: " + errorObject.code);
      });
    } else if (fromState.name === 'start.dash') {
      $rootScope.params = false;
    }
  });

  $rootScope.$on('$stateChangeSuccess', function (toState, fromState) {
    console.log(toState);
    console.log(fromState);

    if (fromState.name === 'start.dash') {
      $rootScope.$broadcast('iso-init', { name: null, params: null });
    }
  });
}).controller('commModalCtrl', function ($modalInstance, $scope) {

  var vm = this;

  $scope.formData = {
    title: '',
    summary: '',
    content: ''
  };

  $scope.ok = function () {
    $modalInstance.close($scope.formData);
  };

  $scope.cancel = function () {
    $modalInstance.dismiss('cancel');
  };
}).controller('considModalCtrl', function ($modalInstance, $scope) {

  var vm = this;

  $scope.formData = {
    description: '',
    user: '',
    job: ''
  };

  $scope.ok = function () {
    $modalInstance.close($scope.formData);
  };

  $scope.cancel = function () {
    $modalInstance.dismiss('cancel');
  };
}).controller('considCtrl', function (FIRE, $scope, $stateParams, $state, $uibModal, $rootScope) {

  var vm = this;

  FIRE.on('value', function (snap) {
    $scope.consid = snap.val();
  }, function (errorObject) {
    console.log("The read failed: " + errorObject.code);
  });

  vm.changeState = _.debounce(function () {
    $rootScope.$broadcast('iso-init', { name: null, params: null });
    // $scope.$emit('iso-method', {name: reloadItems, params:null});
    $state.go('start.dash');
  }, 1000);
}).controller('LoginCtrl', ['$scope', 'Auth', '$location', 'fbutil', function ($scope, Auth, $location, fbutil) {
  $scope.email = null;
  $scope.pass = null;
  $scope.confirm = null;
  $scope.createMode = false;

  $scope.login = function (email, pass) {
    $scope.err = null;
    Auth.$authWithPassword({ email: email, password: pass }, { rememberMe: true }).then(function () /* user */{
      console.log('logged in');
      alert('logged in');
    }, function (err) {
      $scope.err = errMessage(err);
    });
  };

  $scope.createAccount = function () {
    $scope.err = null;
    if (assertValidAccountProps()) {
      var email = $scope.email;
      var pass = $scope.pass;
      // create user credentials in Firebase auth system
      Auth.$createUser({ email: email, password: pass }).then(function () {
        // authenticate so we have permission to write to Firebase
        return Auth.$authWithPassword({ email: email, password: pass });
      }).then(function (user) {
        // create a user profile in our data store
        var ref = fbutil.ref('users', user.uid);
        return fbutil.handler(function (cb) {
          ref.set({ email: email, name: name || firstPartOfEmail(email) }, cb);
        });
      });
    }
  };

  function assertValidAccountProps() {
    if (!$scope.email) {
      $scope.err = 'Please enter an email address';
    } else if (!$scope.pass || !$scope.confirm) {
      $scope.err = 'Please enter a password';
    } else if ($scope.createMode && $scope.pass !== $scope.confirm) {
      $scope.err = 'Passwords do not match';
    }
    return !$scope.err;
  }

  function errMessage(err) {
    return angular.isObject(err) && err.code ? err.code : err + '';
  }

  function firstPartOfEmail(email) {
    return ucfirst(email.substr(0, email.indexOf('@')) || '');
  }

  function ucfirst(str) {
    str += '';
    var f = str.charAt(0).toUpperCase();
    return f + str.substr(1);
  }
}]);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9qcy9tYWluLmNvbnRyb2xsZXIuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxPQUFPLENBQUMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxDQUUxQixVQUFVLENBQUMsTUFBTSxFQUFFLFVBQVMsTUFBTSxFQUFFLFFBQVEsRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLFlBQVksRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLFlBQVksRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFOztBQUVySSxNQUFJLEVBQUUsR0FBRyxJQUFJLENBQUM7O0FBRWQsSUFBRSxDQUFDLGlCQUFpQixHQUFHLElBQUksQ0FBQzs7QUFFNUIsSUFBRSxDQUFDLGdCQUFnQixHQUFHLFlBQVk7QUFDakMsUUFBSSxhQUFhLEdBQUcsU0FBUyxDQUFDLElBQUksQ0FBQztBQUM5QixlQUFTLEVBQUUsRUFBRSxDQUFDLGlCQUFpQjtBQUMvQixpQkFBVyxFQUFFLGtDQUFrQztBQUMvQyxnQkFBVSxFQUFFLGlCQUFpQjtLQUM5QixDQUFDLENBQUM7O0FBRUgsaUJBQWEsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLFVBQVMsUUFBUSxFQUFFO0FBQzVDLGdCQUFVLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFTLE1BQU0sRUFBRTtBQUMvQyxlQUFPLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDO09BQzFCLENBQUMsQ0FBQTtLQUNGLENBQUMsQ0FBQTtHQUVMLENBQUE7O0FBRUEsSUFBRSxDQUFDLFVBQVUsR0FBRyxZQUFZO0FBQzFCLFFBQUksYUFBYSxHQUFHLFNBQVMsQ0FBQyxJQUFJLENBQUM7QUFDL0IsZUFBUyxFQUFFLEVBQUUsQ0FBQyxpQkFBaUI7QUFDL0IsaUJBQVcsRUFBRSxtQ0FBbUM7QUFDaEQsZ0JBQVUsRUFBRSxlQUFlO0tBQzVCLENBQUMsQ0FBQzs7QUFFSCxpQkFBYSxDQUFDLE1BQU0sQ0FB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QUMxQjtDQUNGLENBQUMsQ0FBQyxDQUFDIiwiZmlsZSI6Im1haW4uY29udHJvbGxlci5qcyIsInNvdXJjZXNDb250ZW50IjpbImFuZ3VsYXIubW9kdWxlKCd2YWx1ZXByb3AnKVxuXG4uY29udHJvbGxlcignbWFpbicsIGZ1bmN0aW9uKCRzY29wZSwgRklSRV9PQkosIEZJUkVfQVJSQVksIEdFVF9GSVJFLCBGSVJFX0NPTU1FTlQsICR1aWJNb2RhbCwgJGxvZywgJHN0YXRlUGFyYW1zLCAkc3RhdGUsICRyb290U2NvcGUpIHtcblxuXHR2YXIgdm0gPSB0aGlzO1xuXG5cdHZtLmFuaW1hdGlvbnNFbmFibGVkID0gdHJ1ZTtcblxuXHR2bS5hZGRDb25zaWRlcmF0aW9uID0gZnVuY3Rpb24gKCkge1xuXHRcdHZhciBtb2RhbEluc3RhbmNlID0gJHVpYk1vZGFsLm9wZW4oe1xuXHQgICAgICBhbmltYXRpb246IHZtLmFuaW1hdGlvbnNFbmFibGVkLFxuXHQgICAgICB0ZW1wbGF0ZVVybDogJ2Fzc2V0cy9jb21wb25lbnRzL2FkZENvbnNpZC5odG1sJyxcblx0ICAgICAgY29udHJvbGxlcjogJ2NvbnNpZE1vZGFsQ3RybCdcblx0ICAgIH0pO1xuXG5cdCAgICBtb2RhbEluc3RhbmNlLnJlc3VsdC50aGVuKGZ1bmN0aW9uKGZvcm1EYXRhKSB7XG5cdCAgICBcdEZJUkVfQVJSQVkuJGFkZChmb3JtRGF0YSkudGhlbihmdW5jdGlvbihyZXN1bHQpIHtcblx0ICAgIFx0XHRjb25zb2xlLmxvZyhyZXN1bHQucmVmKCkpO1xuXHQgICAgXHR9KVxuXHQgICAgfSlcblx0XG5cdH1cblxuICB2bS5hZGRDb21tZW50ID0gZnVuY3Rpb24gKCkge1xuICAgIHZhciBtb2RhbEluc3RhbmNlID0gJHVpYk1vZGFsLm9wZW4oe1xuICAgICAgICBhbmltYXRpb246IHZtLmFuaW1hdGlvbnNFbmFibGVkLFxuICAgICAgICB0ZW1wbGF0ZVVybDogJ2Fzc2V0cy9jb21wb25lbnRzL2FkZENvbW1lbnQuaHRtbCcsXG4gICAgICAgIGNvbnRyb2xsZXI6ICdjb21tTW9kYWxDdHJsJ1xuICAgICAgfSk7XG5cbiAgICAgIG1vZGFsSW5zdGFuY2UucmVzdWx0LnRoZW4oZnVuY3Rpb24oZm9ybURhdGEpIHtcbiAgICAgICAgRklSRV9DT01NRU5ULiRhZGQoZm9ybURhdGEpLnRoZW4oZnVuY3Rpb24ocmVzdWx0KSB7XG4gICAgICAgICAgY29uc29sZS5sb2cocmVzdWx0LnJlZigpKTtcbiAgICAgICAgfSlcbiAgICAgIH0pXG4gIFxuICB9XG5cdFxuXG4gICRyb290U2NvcGUuJG9uKCckc3RhdGVDaGFuZ2VTdGFydCcsIGZ1bmN0aW9uICh0b1N0YXRlLCBmcm9tU3RhdGUpIHtcbiAgICBjb25zb2xlLmxvZyh0b1N0YXRlKVxuICAgIGNvbnNvbGUubG9nKGZyb21TdGF0ZSlcblxuICAgaWYgKGZyb21TdGF0ZS5uYW1lID09PSAnc3RhcnQuZGFzaC5jb25zaWQnKSB7XG4gICAgJHJvb3RTY29wZS5wYXJhbXMgPSB0cnVlXG5cbiAgICBHRVRfRklSRS5vbigndmFsdWUnLCBmdW5jdGlvbiAoc25hcCkge1xuICAgICAgdm0uY29tbWVudHMgPSBzbmFwLnZhbCgpXG4gIH0sIGZ1bmN0aW9uIChlcnJvck9iamVjdCkgeyBcbiAgICAgIGNvbnNvbGUubG9nKFwiVGhlIHJlYWQgZmFpbGVkOiBcIiArIGVycm9yT2JqZWN0LmNvZGUpO1xuICB9KVxuICAgfSBlbHNlIGlmIChmcm9tU3RhdGUubmFtZSA9PT0gJ3N0YXJ0LmRhc2gnKSB7XG4gICAgJHJvb3RTY29wZS5wYXJhbXMgPSBmYWxzZVxuICAgfVxuXG4gIH0pXG5cbiAgICAkcm9vdFNjb3BlLiRvbignJHN0YXRlQ2hhbmdlU3VjY2VzcycsIGZ1bmN0aW9uICh0b1N0YXRlLCBmcm9tU3RhdGUpIHtcbiAgICBjb25zb2xlLmxvZyh0b1N0YXRlKVxuICAgIGNvbnNvbGUubG9nKGZyb21TdGF0ZSlcblxuICAgaWYgKGZyb21TdGF0ZS5uYW1lID09PSAnc3RhcnQuZGFzaCcpIHtcbiAgICAgICRyb290U2NvcGUuJGJyb2FkY2FzdCgnaXNvLWluaXQnLCB7bmFtZTpudWxsLCBwYXJhbXM6bnVsbH0pXG5cbiAgIH0gXG5cbiAgfSlcblxuXG5cbn0pXG5cblxuXG4uY29udHJvbGxlcignY29tbU1vZGFsQ3RybCcsIGZ1bmN0aW9uICgkbW9kYWxJbnN0YW5jZSwgJHNjb3BlKSB7XG5cblx0dmFyIHZtID0gdGhpcztcblxuXHQkc2NvcGUuZm9ybURhdGEgPSB7XG5cdFx0dGl0bGU6ICcnLFxuXHRcdHN1bW1hcnk6ICcnLFxuXHRcdGNvbnRlbnQ6ICcnXG5cdH1cblxuICAkc2NvcGUub2sgPSBmdW5jdGlvbiAoKSB7XG4gICAgJG1vZGFsSW5zdGFuY2UuY2xvc2UoJHNjb3BlLmZvcm1EYXRhKTtcbiAgfTtcblxuICAkc2NvcGUuY2FuY2VsID0gZnVuY3Rpb24gKCkge1xuICAgICRtb2RhbEluc3RhbmNlLmRpc21pc3MoJ2NhbmNlbCcpO1xuICB9O1xufSlcblxuLmNvbnRyb2xsZXIoJ2NvbnNpZE1vZGFsQ3RybCcsIGZ1bmN0aW9uICgkbW9kYWxJbnN0YW5jZSwgJHNjb3BlKSB7XG5cblx0dmFyIHZtID0gdGhpcztcblxuXHQkc2NvcGUuZm9ybURhdGEgPSB7XG5cdFx0ZGVzY3JpcHRpb246ICcnLFxuXHRcdHVzZXI6ICcnLFxuXHRcdGpvYjogJydcblx0fVxuXG4gICRzY29wZS5vayA9IGZ1bmN0aW9uICgpIHtcbiAgICAkbW9kYWxJbnN0YW5jZS5jbG9zZSgkc2NvcGUuZm9ybURhdGEpO1xuICB9O1xuXG4gICRzY29wZS5jYW5jZWwgPSBmdW5jdGlvbiAoKSB7XG4gICAgJG1vZGFsSW5zdGFuY2UuZGlzbWlzcygnY2FuY2VsJyk7XG4gIH07XG59KVxuXG4uY29udHJvbGxlcignY29uc2lkQ3RybCcsIGZ1bmN0aW9uIChGSVJFLCAkc2NvcGUsICRzdGF0ZVBhcmFtcywgJHN0YXRlLCAkdWliTW9kYWwsICRyb290U2NvcGUpIHtcblxuXHR2YXIgdm0gPSB0aGlzO1xuXG5cdEZJUkUub24oJ3ZhbHVlJywgZnVuY3Rpb24gKHNuYXApIHtcblx0XHQkc2NvcGUuY29uc2lkID0gc25hcC52YWwoKVxuXHR9LCBmdW5jdGlvbiAoZXJyb3JPYmplY3QpIHtcdFxuXHRcdGNvbnNvbGUubG9nKFwiVGhlIHJlYWQgZmFpbGVkOiBcIiArIGVycm9yT2JqZWN0LmNvZGUpO1xuXHR9KVxuXG5cblxuXG4gIHZtLmNoYW5nZVN0YXRlID0gXy5kZWJvdW5jZShmdW5jdGlvbigpIHtcbiAgICAkcm9vdFNjb3BlLiRicm9hZGNhc3QoJ2lzby1pbml0Jywge25hbWU6bnVsbCwgcGFyYW1zOm51bGx9KVxuICAgICAvLyAkc2NvcGUuJGVtaXQoJ2lzby1tZXRob2QnLCB7bmFtZTogcmVsb2FkSXRlbXMsIHBhcmFtczpudWxsfSk7XG4gICAgJHN0YXRlLmdvKCdzdGFydC5kYXNoJylcbiAgfSwgMTAwMClcblxuXG5cbn0pXG5cblxuXG4uY29udHJvbGxlcignTG9naW5DdHJsJywgWyckc2NvcGUnLCAnQXV0aCcsICckbG9jYXRpb24nLCAnZmJ1dGlsJywgZnVuY3Rpb24oJHNjb3BlLCBBdXRoLCAkbG9jYXRpb24sIGZidXRpbCkge1xuICAgICRzY29wZS5lbWFpbCA9IG51bGw7XG4gICAgJHNjb3BlLnBhc3MgPSBudWxsO1xuICAgICRzY29wZS5jb25maXJtID0gbnVsbDtcbiAgICAkc2NvcGUuY3JlYXRlTW9kZSA9IGZhbHNlO1xuXG4gICAgJHNjb3BlLmxvZ2luID0gZnVuY3Rpb24oZW1haWwsIHBhc3MpIHtcbiAgICAgICRzY29wZS5lcnIgPSBudWxsO1xuICAgICAgQXV0aC4kYXV0aFdpdGhQYXNzd29yZCh7IGVtYWlsOiBlbWFpbCwgcGFzc3dvcmQ6IHBhc3MgfSwge3JlbWVtYmVyTWU6IHRydWV9KVxuICAgICAgICAudGhlbihmdW5jdGlvbigvKiB1c2VyICovKSB7XG4gICAgICAgICAgY29uc29sZS5sb2coJ2xvZ2dlZCBpbicpO1xuICAgICAgICAgIGFsZXJ0KCdsb2dnZWQgaW4nKVxuICAgICAgICB9LCBmdW5jdGlvbihlcnIpIHtcbiAgICAgICAgICAkc2NvcGUuZXJyID0gZXJyTWVzc2FnZShlcnIpO1xuICAgICAgICB9KTtcbiAgICB9O1xuXG4gICAgJHNjb3BlLmNyZWF0ZUFjY291bnQgPSBmdW5jdGlvbigpIHtcbiAgICAgICRzY29wZS5lcnIgPSBudWxsO1xuICAgICAgaWYoIGFzc2VydFZhbGlkQWNjb3VudFByb3BzKCkgKSB7XG4gICAgICAgIHZhciBlbWFpbCA9ICRzY29wZS5lbWFpbDtcbiAgICAgICAgdmFyIHBhc3MgPSAkc2NvcGUucGFzcztcbiAgICAgICAgLy8gY3JlYXRlIHVzZXIgY3JlZGVudGlhbHMgaW4gRmlyZWJhc2UgYXV0aCBzeXN0ZW1cbiAgICAgICAgQXV0aC4kY3JlYXRlVXNlcih7ZW1haWw6IGVtYWlsLCBwYXNzd29yZDogcGFzc30pXG4gICAgICAgICAgLnRoZW4oZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAvLyBhdXRoZW50aWNhdGUgc28gd2UgaGF2ZSBwZXJtaXNzaW9uIHRvIHdyaXRlIHRvIEZpcmViYXNlXG4gICAgICAgICAgICByZXR1cm4gQXV0aC4kYXV0aFdpdGhQYXNzd29yZCh7IGVtYWlsOiBlbWFpbCwgcGFzc3dvcmQ6IHBhc3MgfSk7XG4gICAgICAgICAgfSlcbiAgICAgICAgICAudGhlbihmdW5jdGlvbih1c2VyKSB7XG4gICAgICAgICAgICAvLyBjcmVhdGUgYSB1c2VyIHByb2ZpbGUgaW4gb3VyIGRhdGEgc3RvcmVcbiAgICAgICAgICAgIHZhciByZWYgPSBmYnV0aWwucmVmKCd1c2VycycsIHVzZXIudWlkKTtcbiAgICAgICAgICAgIHJldHVybiBmYnV0aWwuaGFuZGxlcihmdW5jdGlvbihjYikge1xuICAgICAgICAgICAgICByZWYuc2V0KHtlbWFpbDogZW1haWwsIG5hbWU6IG5hbWV8fGZpcnN0UGFydE9mRW1haWwoZW1haWwpfSwgY2IpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfSlcbiAgICAgIH1cbiAgICB9O1xuXG4gICAgZnVuY3Rpb24gYXNzZXJ0VmFsaWRBY2NvdW50UHJvcHMoKSB7XG4gICAgICBpZiggISRzY29wZS5lbWFpbCApIHtcbiAgICAgICAgJHNjb3BlLmVyciA9ICdQbGVhc2UgZW50ZXIgYW4gZW1haWwgYWRkcmVzcyc7XG4gICAgICB9XG4gICAgICBlbHNlIGlmKCAhJHNjb3BlLnBhc3MgfHwgISRzY29wZS5jb25maXJtICkge1xuICAgICAgICAkc2NvcGUuZXJyID0gJ1BsZWFzZSBlbnRlciBhIHBhc3N3b3JkJztcbiAgICAgIH1cbiAgICAgIGVsc2UgaWYoICRzY29wZS5jcmVhdGVNb2RlICYmICRzY29wZS5wYXNzICE9PSAkc2NvcGUuY29uZmlybSApIHtcbiAgICAgICAgJHNjb3BlLmVyciA9ICdQYXNzd29yZHMgZG8gbm90IG1hdGNoJztcbiAgICAgIH1cbiAgICAgIHJldHVybiAhJHNjb3BlLmVycjtcbiAgICB9XG5cbiAgICBmdW5jdGlvbiBlcnJNZXNzYWdlKGVycikge1xuICAgICAgcmV0dXJuIGFuZ3VsYXIuaXNPYmplY3QoZXJyKSAmJiBlcnIuY29kZT8gZXJyLmNvZGUgOiBlcnIgKyAnJztcbiAgICB9XG5cbiAgICBmdW5jdGlvbiBmaXJzdFBhcnRPZkVtYWlsKGVtYWlsKSB7XG4gICAgICByZXR1cm4gdWNmaXJzdChlbWFpbC5zdWJzdHIoMCwgZW1haWwuaW5kZXhPZignQCcpKXx8JycpO1xuICAgIH1cblxuICAgIGZ1bmN0aW9uIHVjZmlyc3QgKHN0cikge1xuICAgICAgc3RyICs9ICcnO1xuICAgICAgdmFyIGYgPSBzdHIuY2hhckF0KDApLnRvVXBwZXJDYXNlKCk7XG4gICAgICByZXR1cm4gZiArIHN0ci5zdWJzdHIoMSk7XG4gICAgfVxuICB9XSk7XG4iXX0=
